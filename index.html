<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
</head>

<body>
<form id="form">
<input type="text" id="cityName" name="cityName" />
</form>


<div id="divButtons" >
 <!--<button class="buttons" onclick="openWeather()" name="London">London</button>
 <button class="buttons" onclick="openWeather()" name="Paris">Paris</button>
-->
</div>
<div id="weatherInfo">
    
</div>

<script>
//Default citys
var citys = {London : {}, NY :{} };

    
//Есть ли у юзера уже настройки
if (localStorage.getItem('citys') === null) {
    alert("Впервые на сайте");


//add to local storage
var storedNames = JSON.stringify(citys);
localStorage.setItem("citys", storedNames);

//выводим кнопки с городами
for (var cityName in citys){
    createButton(cityName);
}


    

}
    else {
        alert("yes");
        var storage = JSON.parse(localStorage.getItem("citys"))


        //выводим кнопки с городами
        for (var cityName in storage){
            createButton(cityName);
        }
        
    }
var apikey = '82a0816e42bd78a6425eb1adca71428f';
    
function openWeather(){
    event.preventDefault;
      var cityName = event.target.name;
      weatherOpen(cityName);
}
      
//
document.querySelector("#form").addEventListener("submit", function(event){
event.preventDefault();
var gcn = new XMLHttpRequest();
var apikey = '82a0816e42bd78a6425eb1adca71428f';
var name = document.querySelector("#cityName").value;
    
var params = 'q=' + encodeURIComponent(name) + 
    "&appid=" + encodeURIComponent(apikey);
var request = "http://api.openweathermap.org/data/2.5/weather?" + params;
alert(request);
gcn.open("GET", request, false);

gcn.send();
if (gcn.status != 200) {
         //обработать ошибку
        alert('Ошибка ' + gcn.status + ': ' + gcn.statusText);
      } else {
          //add city in array
          //нужно обновлять объект из localstorage, т.к. берет стандартных 2 города, а их там может быть уже больше
          var storage = JSON.parse(localStorage.getItem("citys"));
          //добавляем
          storage[name] = {};

          //add array too localstorage
          storedNames = JSON.stringify(storage);
          localStorage.setItem("citys", storedNames);
          
          createButton(name);
 }    

    
});    

function createButton(buttonName){
    var button = document.createElement('button');
          button.name = buttonName;
          button.id = buttonName;
          button.innerHTML = buttonName;
          button.onclick = function() {openWeather() };
          document.querySelector("#divButtons").appendChild(button);
}
function weatherOpen(cityName) {   
      var xhr = new XMLHttpRequest();
        var request = "http://api.openweathermap.org/data/2.5/weather?q=" + cityName + '&appid=' + apikey;
      xhr.open('GET', request, false);
      xhr.send();

      if (xhr.status != 200) {
        // обработать ошибку
        alert('Ошибка ' + xhr.status + ': ' + xhr.statusText);
      } else {
          var value = JSON.parse(xhr.responseText);
          var weatherMain = document.createElement('p');
          weatherMain.innerHTML = value.weather[0].main;
          var weatherTemp = document.createElement('p');
          weatherTemp.innerHTML = value.main.temp;
          weatherInfo.appendChild(weatherMain);
          weatherInfo.appendChild(weatherTemp);
        
       
      }
    }
  </script>

</body>

</html>